const { PrismaClient } = require('@prisma/client');
const {
    models,
    audioModels,
    fineTuningModels,
    assistantsAPI,
    transcriptionSpeechModels,
    imageGenerationModels,
    embeddingsModels
} = require('../src/data/llm-models/models');

const prisma = new PrismaClient();

async function loadModels() {
    console.log('üöÄ Starting Model Load into Prisma Database...');

    const allModelSets = [
        { category: 'Chat', data: models },
        { category: 'Audio', data: audioModels },
        { category: 'Fine-Tuning', data: fineTuningModels },
        { category: 'Assistants', data: assistantsAPI },
        { category: 'Transcription Speech', data: transcriptionSpeechModels },
        { category: 'Image Generation', data: imageGenerationModels },
        { category: 'Embeddings', data: embeddingsModels },
    ];

    for (const { category, data } of allModelSets) {
        console.log(`üìå Processing ${category}...`);

        for (const model of data) {
            try {
                const providerData = model.aiProvider || {
                    category: 'Other',
                    provider: 'Unknown',
                    modelType: 'LLM'
                };

                // ‚úÖ FIXED: Correct AIProvider lookup
                let aiProvider = await prisma.aIProvider.findFirst({
                    where: {
                        category: providerData.category,
                        provider: providerData.provider
                    }
                });

                // ‚úÖ Ensure AIProvider exists
                if (!aiProvider) {
                    aiProvider = await prisma.aIProvider.create({
                        data: {
                            category: providerData.category,
                            provider: providerData.provider,
                            modelType: providerData.modelType
                        }
                    });
                    console.log(`‚úÖ Created AIProvider: ${providerData.category} - ${providerData.provider}`);
                }

                // ‚úÖ FIXED: Model lookup
                const existingModel = await prisma.model.findUnique({
                    where: { name: model.name }
                });

                if (!existingModel) {
                    await prisma.model.create({
                        data: {
                            name: model.name,
                            description: model.description || null,
                            type: model.type || category,
                            inputCost: model.inputCost || null,
                            cachedInputCost: model.cachedInputCost || null,
                            outputCost: model.outputCost || null,
                            totalCost: model.totalCost || null,
                            providerId: aiProvider.id  // ‚úÖ Associate with AIProvider
                        }
                    });
                    console.log(`‚úÖ Added: ${model.name}`);
                } else {
                    console.log(`‚ö†Ô∏è Skipping (Already Exists): ${model.name}`);
                }
            } catch (error) {
                console.error(`‚ùå Error inserting ${model.name}:`, error);
            }
        }
    }

    await prisma.$disconnect();
    console.log('‚úÖ Model Load Complete.');
}

// Run the script if executed directly
if (require.main === module) {
    loadModels();
}
